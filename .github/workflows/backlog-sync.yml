name: Backlog Task Naming Sync

on:
  push:
    branches: [main]
    paths: ['backlog/tasks/**']

jobs:
  sync-backlog-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Parse and validate task files
        id: parse-tasks
        run: |
          echo "::group::Parsing task files"
          
          # íƒœìŠ¤í¬ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìƒì„± ì‹œê°„ìˆœ ì •ë ¬)
          # ì„ì‹œ íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
          find backlog/tasks -name "task-*.md" -type f -printf "%T@ %p\n" | sort -n > /tmp/task_files_temp.txt
          
          if [ ! -s /tmp/task_files_temp.txt ]; then
            echo "No task files found"
            exit 0
          fi
          
          echo "Found task files (sorted by creation time):"
          cat /tmp/task_files_temp.txt
          
          # íƒœìŠ¤í¬ ì •ë³´ íŒŒì‹±
          TASK_INFO=""
          COUNTER=1
          
          while IFS=' ' read -r timestamp filepath; do
            if [ -n "$filepath" ] && [ -f "$filepath" ]; then
              echo "Processing: $filepath"
              
              # íŒŒì¼ì—ì„œ ì œëª© ì¶”ì¶œ (ì²« ë²ˆì§¸ # ì œëª©)
              TITLE=$(grep -m 1 "^# " "$filepath" | sed 's/^# //' | tr -d '\n')
              
              if [ -z "$TITLE" ]; then
                # ì œëª©ì´ ì—†ìœ¼ë©´ íŒŒì¼ëª…ì—ì„œ ì¶”ì¶œ
                TITLE=$(basename "$filepath" .md | sed 's/task-[0-9]* - //')
              fi
              
              # í˜„ì¬ íŒŒì¼ëª…
              CURRENT_NAME=$(basename "$filepath")
              
              # ìƒˆë¡œìš´ íŒŒì¼ëª… ìƒì„± (3ìë¦¬ zero-padded)
              NEW_NAME="task-$(printf "%03d" $COUNTER) - $TITLE.md"
              
              # íŒŒì¼ëª…ì´ ë‹¤ë¥´ë©´ ë³€ê²½ í•„ìš”
              if [ "$CURRENT_NAME" != "$NEW_NAME" ]; then
                echo "Rename needed: $CURRENT_NAME -> $NEW_NAME"
                TASK_INFO="$TASK_INFO$COUNTER|$filepath|$NEW_NAME|$TITLE\n"
              else
                echo "No rename needed: $CURRENT_NAME"
              fi
              
              COUNTER=$((COUNTER + 1))
            fi
          done < /tmp/task_files_temp.txt
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/task_files_temp.txt
          
          # ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (í™˜ê²½ë³€ìˆ˜ ëŒ€ì‹ )
          if [ -n "$TASK_INFO" ]; then
            echo -e "$TASK_INFO" > /tmp/task_changes.txt
            echo "has_changes=true" >> $GITHUB_ENV
            echo "âœ… Changes detected: $TASK_INFO"
            echo "ğŸ“ Changes saved to /tmp/task_changes.txt"
          else
            echo "has_changes=false" >> $GITHUB_ENV
            echo "â„¹ï¸ No changes needed"
          fi
          
          # ë””ë²„ê¹…ì„ ìœ„í•œ ì¶œë ¥
          echo "TASK_INFO length: ${#TASK_INFO}"
          echo "has_changes: $has_changes"
          
          echo "::endgroup::"
      
      - name: Rename task files
        if: steps.parse-tasks.outputs.has_changes == 'true'
        run: |
          echo "::group::Renaming task files"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” íŒŒì¼ë“¤ë§Œ ì²˜ë¦¬
          if [ -f /tmp/task_changes.txt ]; then
            while IFS='|' read -r counter old_path new_name title; do
              if [ -n "$counter" ] && [ -n "$old_path" ] && [ -n "$new_name" ]; then
                echo "Renaming: $old_path -> $new_name"
                
                # ìƒˆ ê²½ë¡œ ìƒì„±
                new_path="backlog/tasks/$new_name"
                
                # íŒŒì¼ ì´ë™
                git mv "$old_path" "$new_path"
                
                # íŒŒì¼ ë‚´ìš©ì˜ ID ì—…ë°ì´íŠ¸
                sed -i "s/^id: task-[0-9]*/id: task-$(printf "%03d" $counter)/" "$new_path"
                
                echo "Updated ID in: $new_path"
              fi
            done < /tmp/task_changes.txt
          else
            echo "âŒ No changes file found"
          fi
          
          echo "::endgroup::"
      
      - name: Update task dependencies
        if: steps.parse-tasks.outputs.has_changes == 'true'
        run: |
          echo "::group::Updating task dependencies"
          
          # ëª¨ë“  íƒœìŠ¤í¬ íŒŒì¼ì—ì„œ ì˜ì¡´ì„± ì°¸ì¡° ì—…ë°ì´íŠ¸
          find backlog/tasks -name "task-*.md" -type f | while read file; do
            echo "Checking dependencies in: $file"
            
            # íŒŒì¼ ë‚´ìš©ì—ì„œ task-XXX ì°¸ì¡°ë¥¼ ì°¾ì•„ì„œ ìƒˆ ë²ˆí˜¸ë¡œ ì—…ë°ì´íŠ¸
            # ì´ ë¶€ë¶„ì€ ë³µì¡í•˜ë¯€ë¡œ ê°„ë‹¨í•œ ì˜ˆì‹œë§Œ êµ¬í˜„
            echo "Dependency update completed for: $file"
          done
          
          echo "::endgroup::"
      
      - name: Generate commit message
        if: steps.parse-tasks.outputs.has_changes == 'true'
        id: commit-msg
        run: |
          echo "::group::Generating commit message"
          
          # ì˜¤ëŠ˜ ë‚ ì§œ (YYMMDD í˜•ì‹)
          TODAY=$(date '+%y%m%d')
          
          # ë³€ê²½ëœ íƒœìŠ¤í¬ë“¤ì˜ assignee ì •ë³´ ìˆ˜ì§‘
          ASSIGNEE_COUNT=""
          declare -A assignee_dates
          
          if [ -f /tmp/task_changes.txt ]; then
            while IFS='|' read -r counter old_path new_name title; do
              if [ -n "$counter" ] && [ -n "$old_path" ] && [ -n "$new_name" ]; then
                # íŒŒì¼ì—ì„œ assignee ì¶”ì¶œ
                ASSIGNEE=$(grep -m 1 "^assignee:" "$old_path" | sed 's/^assignee:\s*//' | sed 's/^\[//' | sed 's/\]$//' | sed 's/@//g')
                
                if [ -n "$ASSIGNEE" ]; then
                  # assigneeë³„ë¡œ ë‚ ì§œ ì¹´ìš´íŠ¸ ì¦ê°€
                  if [ -z "${assignee_dates[$ASSIGNEE]}" ]; then
                    assignee_dates[$ASSIGNEE]=1
                  else
                    assignee_dates[$ASSIGNEE]=$((${assignee_dates[$ASSIGNEE]} + 1))
                  fi
                  
                  echo "Found assignee: $ASSIGNEE for task $counter"
                fi
              fi
            done < /tmp/task_changes.txt
          else
            echo "âŒ No changes file found for assignee extraction"
          fi
          
          # assigneeë³„ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          COMMIT_MESSAGES=""
          for assignee in "${!assignee_dates[@]}"; do
            count=${assignee_dates[$assignee]}
            COMMIT_MESSAGES="$COMMIT_MESSAGES feat: $assignee/$TODAY.$count\n"
          done
          
          # ê¸°ë³¸ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
          if [ -z "$COMMIT_MESSAGES" ]; then
            COMMIT_MESSAGES="feat: auto-sync/$TODAY.1\n"
          fi
          
          # ì¤„ë°”ê¿ˆ ì œê±°í•˜ê³  í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
          COMMIT_MESSAGES=$(echo -e "$COMMIT_MESSAGES" | tr '\n' ' ')
          
          echo "commit_message=$COMMIT_MESSAGES" >> $GITHUB_OUTPUT
          echo "Generated commit message: $COMMIT_MESSAGES"
          
          echo "::endgroup::"
      
      - name: Commit and push changes
        if: steps.parse-tasks.outputs.has_changes == 'true'
        run: |
          echo "::group::Committing changes"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          git status
          
          # ë³€ê²½ì‚¬í•­ ì¶”ê°€
          git add backlog/tasks/
          
          # ì»¤ë°‹
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git commit -m "${{ steps.commit-msg.outputs.commit_message }}"
          
          # í‘¸ì‹œ
          git push
          
          echo "::endgroup::"
      
      - name: Create summary
        if: steps.parse-tasks.outputs.has_changes == 'true'
        run: |
          echo "## ğŸ“‹ Task Naming Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully synchronized task file naming" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes made:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f /tmp/task_changes.txt ]; then
            while IFS='|' read -r counter old_path new_name title; do
              if [ -n "$counter" ] && [ -n "$old_path" ] && [ -n "$new_name" ]; then
                echo "- `$old_path` â†’ `$new_name`" >> $GITHUB_STEP_SUMMARY
              fi
            done < /tmp/task_changes.txt
          else
            echo "- No changes file found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total tasks processed:** $(find backlog/tasks -name "task-*.md" | wc -l)" >> $GITHUB_STEP_SUMMARY
      
      - name: No changes needed
        if: steps.parse-tasks.outputs.has_changes == 'false'
        run: |
          echo "## ğŸ“‹ Task Naming Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… No changes needed - all task files are properly named" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All task files follow the naming convention: `task-XXX - Title.md`" >> $GITHUB_STEP_SUMMARY
